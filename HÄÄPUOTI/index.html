<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <title>HAAPUOTI ZIP Extractor</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
  <h2>HAAPUOTI ‚Äì –ò–∑—Ç–µ–≥–ª—è–Ω–µ –Ω–∞ –≤—Å–∏—á–∫–∏ –ø—Ä–æ–¥—É–∫—Ç–∏</h2>
  <button onclick="openAndExtract()">üü¢ –û—Ç–≤–æ—Ä–∏ –º–∞–≥–∞–∑–∏–Ω–∞ –∏ –∏–∑—Ç–µ–≥–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–∏—Ç–µ</button>

  <script>
    async function openAndExtract() {
      const popup = window.open("https://holvi.com/shop/HAAPUOTI/", "_blank");
      if (!popup) {
        alert("–ú–æ–ª—è, —Ä–∞–∑—Ä–µ—à–∏ –∏–∑—Å–∫–∞—á–∞—â–∏ –ø—Ä–æ–∑–æ—Ä—Ü–∏ (pop-ups) –∑–∞ —Ç–æ–∑–∏ —Å–∞–π—Ç.");
        return;
      }

      popup.onload = async function () {
        try {
          const doc = popup.document;
          const products = doc.querySelectorAll('[data-product]');
          const zip = new JSZip();
          const productList = [];

          for (let i = 0; i < products.length; i++) {
            const el = products[i];
            const title = el.querySelector('h3')?.innerText || 'No title';
            const price = el.querySelector('.product-price')?.innerText || 'No price';
            const img = el.querySelector('img')?.src || '';

            const product = { title, price, image: img };
            productList.push(product);

            if (img) {
              try {
                const imgBlob = await fetch(img).then(r => r.blob());
                const ext = img.split('.').pop().split('?')[0].slice(0, 4);
                zip.file(`images/product_${i + 1}.${ext}`, imgBlob);
              } catch (e) {
                console.warn("–ù–µ –º–æ–∂–∞ –¥–∞ —Å–≤–∞–ª–∏ —Å–Ω–∏–º–∫–∞:", img);
              }
            }
          }

          zip.file("products.json", JSON.stringify(productList, null, 2));

          const content = await zip.generateAsync({ type: "blob" });
          const a = document.createElement("a");
          a.href = URL.createObjectURL(content);
          a.download = "haapuoti_products.zip";
          a.click();

          alert("–ì–æ—Ç–æ–≤–æ! ZIP —Ñ–∞–π–ª—ä—Ç –µ –∏–∑—Ç–µ–≥–ª–µ–Ω.");
          popup.close();
        } catch (e) {
          alert("–ù–µ—É—Å–ø–µ—à–µ–Ω –¥–æ—Å—Ç—ä–ø –¥–æ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ. –ë—Ä–∞—É–∑—ä—Ä—ä—Ç –±–ª–æ–∫–∏—Ä–∞ –¥–æ—Å—Ç—ä–ø–∞ (CORS).");
        }
      };
    }
  </script>
</body>
</html>
